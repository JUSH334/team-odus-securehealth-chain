<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureHealth Chain - Patient Dashboard</title>
    <!-- Ethers.js Library for Blockchain Integration -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
        }

        .header-left h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header-left p {
            font-size: 13px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-id {
            font-size: 12px;
            opacity: 0.8;
            font-family: monospace;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        /* Sidebar Navigation */
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e5e7eb;
            padding: 30px 0;
        }

        .nav-item {
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s;
            color: #6b7280;
            font-weight: 500;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: #f9fafb;
            color: #667eea;
        }

        .nav-item.active {
            background: #eff6ff;
            color: #667eea;
            border-left-color: #667eea;
        }

        .nav-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .page-title {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 30px;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-icon {
            font-size: 28px;
            opacity: 0.8;
        }

        .stat-label {
            color: #6b7280;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin: 5px 0;
        }

        .stat-change {
            font-size: 12px;
            color: #10b981;
            font-weight: 500;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f3f4f6;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .info-item {
            padding: 15px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #6b7280;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .info-value {
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
        }

        /* Bill Cards */
        .bills-grid {
            display: grid;
            gap: 20px;
        }

        .bill-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
        }

        .bill-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .bill-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .bill-info h3 {
            font-size: 18px;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .bill-id {
            font-size: 12px;
            color: #6b7280;
            font-family: monospace;
        }

        .bill-amount {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
        }

        .bill-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .bill-detail {
            font-size: 14px;
        }

        .bill-detail-label {
            color: #6b7280;
            display: block;
            margin-bottom: 5px;
        }

        .bill-detail-value {
            color: #1f2937;
            font-weight: 500;
        }

        .bill-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-paid {
            background: #d1fae5;
            color: #065f46;
        }

        .pay-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .pay-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Blockchain Section */
        .blockchain-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
        }

        .blockchain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .blockchain-title {
            font-size: 20px;
            font-weight: 600;
        }

        .chain-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .wallet-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .wallet-item {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .wallet-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .wallet-value {
            font-size: 28px;
            font-weight: 700;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 12px;
            opacity: 0.9;
            word-break: break-all;
            margin-top: 5px;
        }

        .explorer-link {
            display: inline-block;
            margin-top: 15px;
            color: white;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            transition: all 0.3s;
        }

        .explorer-link:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Transaction History */
        .transaction-list {
            display: grid;
            gap: 15px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .transaction-item:hover {
            background: #f3f4f6;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-type {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .transaction-meta {
            font-size: 12px;
            color: #6b7280;
            font-family: monospace;
        }

        .transaction-amount {
            font-size: 20px;
            font-weight: 700;
            color: #10b981;
        }

        .tx-detail-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .tx-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .tx-detail-row:last-child {
            border-bottom: none;
        }

        .tx-detail-label {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        .tx-detail-value {
            color: #1f2937;
            font-weight: 600;
            font-size: 14px;
            font-family: monospace;
        }

        .explorer-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .explorer-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 24px;
            color: #1f2937;
            font-weight: 600;
        }

        .modal-close {
            font-size: 32px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s;
            line-height: 1;
        }

        .modal-close:hover {
            color: #1f2937;
            transform: rotate(90deg);
        }

        .warning-box {
            background: #fef3c7;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #f59e0b;
        }

        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spinner 0.6s linear infinite;
            margin-right: 8px;
        }

        @keyframes spinner {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                display: flex;
                overflow-x: auto;
                padding: 0;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }

            .nav-item {
                border-left: none;
                border-bottom: 3px solid transparent;
                white-space: nowrap;
            }

            .nav-item.active {
                border-left-color: transparent;
                border-bottom-color: #667eea;
            }

            .wallet-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <h1>🏥 SecureHealth Chain</h1>
                <p>Decentralized Healthcare Payment Platform</p>
            </div>
            <div class="header-right">
                <button class="logout-btn" onclick="connectWallet()" id="connectWalletBtn" style="margin-right: 10px; background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: white;">
                    🔗 Connect Wallet
                </button>
                <div class="user-info">
                    <div class="user-name" id="userName">John Doe</div>
                    <div class="user-id" id="userID">MEM123456ABC</div>
                </div>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="nav-item active" onclick="showSection('dashboard')">
                <span class="nav-icon">📊</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="showSection('bills')">
                <span class="nav-icon">🏥</span>
                <span>Medical Bills</span>
            </div>
            <div class="nav-item" onclick="showSection('prescriptions')">
                <span class="nav-icon">💊</span>
                <span>Prescriptions</span>
            </div>
            <div class="nav-item" onclick="showSection('blockchain')">
                <span class="nav-icon">⛓️</span>
                <span>Blockchain</span>
            </div>
            <div class="nav-item" onclick="showSection('profile')">
                <span class="nav-icon">👤</span>
                <span>Profile</span>
            </div>
            <div class="nav-item" onclick="showSection('transactions')">
                <span class="nav-icon">📜</span>
                <span>Transaction History</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboardSection">
                <h1 class="page-title">Dashboard Overview</h1>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-label">Outstanding Balance</div>
                            <div class="stat-icon">💵</div>
                        </div>
                        <div class="stat-value" id="outstandingBalance">$425.50</div>
                        <div class="stat-change">2 pending payments</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-label">Total Paid</div>
                            <div class="stat-icon">✅</div>
                        </div>
                        <div class="stat-value" id="totalPaid">$352.00</div>
                        <div class="stat-change">Via blockchain</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-label">Network Gas Saved</div>
                            <div class="stat-icon">⚡</div>
                        </div>
                        <div class="stat-value">$8.50</div>
                        <div class="stat-change">DIDLab QBFT Network</div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>📋</span>
                            Recent Activity
                        </div>
                    </div>
                    <div class="transaction-list" id="recentActivity"></div>
                </div>
            </div>

            <!-- Medical Bills Section -->
            <div class="content-section" id="billsSection">
                <h1 class="page-title">Medical Bills</h1>
                <div class="bills-grid" id="billsList"></div>
            </div>

            <!-- Prescriptions Section -->
            <div class="content-section" id="prescriptionsSection">
                <h1 class="page-title">Prescriptions</h1>
                <div class="bills-grid" id="prescriptionsList"></div>
            </div>

            <!-- Blockchain Section -->
            <div class="content-section" id="blockchainSection">
                <h1 class="page-title">Blockchain Wallet</h1>

                <!-- Blockchain Card -->
                <div class="blockchain-card">
                    <div class="blockchain-header">
                        <div class="blockchain-title">DIDLab QBFT Network</div>
                        <div class="chain-badge">Hyperledger Besu</div>
                    </div>
                    <div class="wallet-info">
                        <div class="wallet-item">
                            <div class="wallet-label">Wallet Balance</div>
                            <div class="wallet-value" id="walletBalance">$352.00</div>
                        </div>
                        <div class="wallet-item">
                            <div class="wallet-label">Gas Token</div>
                            <div class="wallet-value">TT (Trust Token)</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <div class="wallet-label">Your Wallet Address</div>
                        <div class="wallet-address" id="walletAddress">0x742d35Cc6634C0532925a3b844Bc454e4438f44e</div>
                        <a href="https://explorer.didlab.org/" target="_blank" class="explorer-link">
                            View on DIDLab Explorer →
                        </a>
                    </div>
                </div>

                <!-- Transaction History -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>📊</span>
                            Transaction History
                        </div>
                    </div>
                    <div class="transaction-list" id="transactionHistory"></div>
                </div>

                <!-- Blockchain Info -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>ℹ️</span>
                            Network Information
                        </div>
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Network</div>
                            <div class="info-value">DIDLab QBFT</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Consensus</div>
                            <div class="info-value">QBFT (Byzantine Fault Tolerant)</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Gas Token</div>
                            <div class="info-value">Trust Token (TT)</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Explorer</div>
                            <div class="info-value">
                                <a href="https://explorer.didlab.org/" target="_blank" style="color: #667eea; text-decoration: none;">
                                    explorer.didlab.org →
                                </a>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Network Type</div>
                            <div class="info-value">Hyperledger Besu</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Use Case</div>
                            <div class="info-value">Healthcare Payments</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div class="content-section" id="profileSection">
                <h1 class="page-title">Patient Profile</h1>
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Transaction History Section -->
            <div class="content-section" id="transactionsSection">
                <h1 class="page-title">Complete Transaction History</h1>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>📜</span>
                            All Blockchain Transactions
                        </div>
                    </div>
                    <div id="fullTransactionList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Confirm Payment</div>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div id="paymentDetails"></div>
            <button class="pay-btn" id="confirmPayBtn" onclick="processPayment()">
                Confirm & Pay via Blockchain
            </button>
        </div>
    </div>

    <script>
        // ===== BLOCKCHAIN CONFIGURATION =====
        const PAYMENT_CONTRACT_ADDRESS = "0xeEb5D7E64ecF0F4BE1d4Eb3c9cDac156A698Cd0a";
        const PAYMENT_CONTRACT_ABI = [
            "function processPayment(string _paymentId, string _itemId, string _itemType, string _memberID) public payable returns (bool)",
            "function getPayment(string _paymentId) public view returns (string itemId, string itemType, address payer, uint256 amount, uint256 timestamp, bool completed)",
            "function isItemPaid(string _itemId) public view returns (bool)",
            "function getUserPayments(address _user) public view returns (string[] memory)",
            "function getStats() public view returns (uint256 paymentsProcessed, uint256 amountProcessed, uint256 contractBalance)",
            "event PaymentProcessed(string indexed paymentId, string itemId, address indexed payer, uint256 amount, uint256 timestamp)"
        ];

        let provider = null;
        let signer = null;
        let contract = null;
        let userAddress = null;
        let currentPaymentItem = null;
        let isBlockchainConnected = false;

        // ===== BLOCKCHAIN INITIALIZATION =====
        
        // Connect wallet and initialize blockchain
        async function connectWallet() {
            const connectBtn = document.getElementById('connectWalletBtn');
            const originalText = connectBtn.textContent;
            
            try {
                connectBtn.disabled = true;
                connectBtn.textContent = '🔄 Connecting...';
                
                // Check if MetaMask is installed
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask not detected. Please install MetaMask browser extension.');
                }

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found. Please unlock MetaMask.');
                }
                
                // Create provider and signer
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Get network info
                const network = await provider.getNetwork();
                console.log('Connected to network:', network);
                
                // Check if on correct network (DIDLab Chain ID: 252501)
                if (network.chainId !== 252501) {
                    console.warn('Not on DIDLab network. Current chain ID:', network.chainId);
                    // Try to switch network
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x3DAF5' }], // 252501 in hex
                        });
                    } catch (switchError) {
                        // If network not added, add it
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x3DAF5',
                                    chainName: 'DIDLab QBFT Network',
                                    nativeCurrency: {
                                        name: 'Trust Token',
                                        symbol: 'TT',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://rpc.didlab.io'],
                                    blockExplorerUrls: ['https://explorer.didlab.org/']
                                }]
                            });
                        }
                    }
                }
                
                // Initialize contract
                contract = new ethers.Contract(
                    PAYMENT_CONTRACT_ADDRESS,
                    PAYMENT_CONTRACT_ABI,
                    signer
                );
                
                // Get wallet balance
                const balance = await provider.getBalance(userAddress);
                const balanceInEth = ethers.utils.formatEther(balance);
                
                // Update UI
                document.getElementById('walletAddress').textContent = userAddress;
                
                isBlockchainConnected = true;
                connectBtn.textContent = '✅ Wallet Connected';
                connectBtn.style.background = 'rgba(16, 185, 129, 0.3)';
                connectBtn.disabled = true;
                
                console.log('✅ Blockchain connected successfully');
                console.log('Wallet Address:', userAddress);
                console.log('Balance:', balanceInEth, 'TT');
                console.log('Contract Address:', PAYMENT_CONTRACT_ADDRESS);
                console.log('Network:', network.name, 'Chain ID:', network.chainId);
                
                // Try to get contract stats
                try {
                    const stats = await contract.getStats();
                    console.log('Contract Stats:');
                    console.log('  - Payments Processed:', stats.paymentsProcessed.toString());
                    console.log('  - Amount Processed:', ethers.utils.formatEther(stats.amountProcessed), 'TT');
                    console.log('  - Contract Balance:', ethers.utils.formatEther(stats.contractBalance), 'TT');
                } catch (e) {
                    console.warn('Could not fetch contract stats:', e.message);
                }
                
                return true;
                
            } catch (error) {
                console.error('Blockchain connection failed:', error);
                
                let errorMessage = 'Failed to connect wallet: ';
                if (error.code === 4001) {
                    errorMessage += 'Connection request rejected by user.';
                } else if (error.message.includes('MetaMask')) {
                    errorMessage += error.message;
                } else {
                    errorMessage += error.message || 'Unknown error occurred.';
                }
                
                alert(errorMessage);
                
                connectBtn.disabled = false;
                connectBtn.textContent = originalText;
                
                return false;
            }
        }

        // Auto-initialize blockchain (silent, no prompt)
        async function initBlockchain() {
            try {
                // Check if MetaMask is installed
                if (typeof window.ethereum === 'undefined') {
                    console.warn('MetaMask not detected');
                    return false;
                }

                // Check if already connected
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                
                if (accounts && accounts.length > 0) {
                    // Already connected, initialize silently
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = accounts[0];
                    
                    contract = new ethers.Contract(
                        PAYMENT_CONTRACT_ADDRESS,
                        PAYMENT_CONTRACT_ABI,
                        signer
                    );
                    
                    document.getElementById('walletAddress').textContent = userAddress;
                    
                    const connectBtn = document.getElementById('connectWalletBtn');
                    connectBtn.textContent = '✅ Wallet Connected';
                    connectBtn.style.background = 'rgba(16, 185, 129, 0.3)';
                    connectBtn.disabled = true;
                    
                    isBlockchainConnected = true;
                    
                    console.log('✅ Blockchain auto-connected');
                    console.log('Wallet:', userAddress);
                    
                    return true;
                }
                
                return false;
                
            } catch (error) {
                console.warn('Auto-init failed:', error.message);
                return false;
            }
        }

        // Listen for account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    console.log('Wallet disconnected');
                    isBlockchainConnected = false;
                    const connectBtn = document.getElementById('connectWalletBtn');
                    connectBtn.textContent = '🔗 Connect Wallet';
                    connectBtn.style.background = 'rgba(16, 185, 129, 0.2)';
                    connectBtn.disabled = false;
                } else {
                    console.log('Account changed to:', accounts[0]);
                    window.location.reload(); // Reload to reinitialize
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                console.log('Network changed to:', chainId);
                window.location.reload(); // Reload on network change
            });
        }

        // Mock data
        const mockBills = [
            {
                id: 'BILL001',
                type: 'Medical Consultation',
                provider: 'Dr. Sarah Smith - General Practice',
                date: '2025-01-15',
                amount: 150.00,
                status: 'pending',
                description: 'Annual checkup and health assessment'
            },
            {
                id: 'BILL002',
                type: 'Laboratory Tests',
                provider: 'HealthLab Diagnostics Center',
                date: '2025-01-18',
                amount: 275.50,
                status: 'pending',
                description: 'Comprehensive blood work and urinalysis'
            },
            {
                id: 'BILL003',
                type: 'X-Ray Imaging',
                provider: 'Central Medical Imaging',
                date: '2025-01-10',
                amount: 320.00,
                status: 'paid',
                description: 'Chest X-ray examination',
                paidDate: '2025-01-12',
                transactionHash: '0xabcd1234ef5678901234567890abcdef12345678'
            }
        ];

        const mockPrescriptions = [
            {
                id: 'RX001',
                medication: 'Amoxicillin 500mg',
                prescriber: 'Dr. Sarah Smith',
                date: '2025-01-15',
                quantity: 30,
                refills: 2,
                amount: 45.00,
                status: 'pending',
                pharmacy: 'HealthPlus Pharmacy'
            },
            {
                id: 'RX002',
                medication: 'Lisinopril 10mg',
                prescriber: 'Dr. Michael Johnson',
                date: '2025-01-10',
                quantity: 90,
                refills: 3,
                amount: 28.50,
                status: 'pending',
                pharmacy: 'HealthPlus Pharmacy'
            },
            {
                id: 'RX003',
                medication: 'Metformin 500mg',
                prescriber: 'Dr. Sarah Smith',
                date: '2024-12-20',
                quantity: 60,
                refills: 0,
                amount: 32.00,
                status: 'paid',
                pharmacy: 'HealthPlus Pharmacy',
                paidDate: '2024-12-21',
                transactionHash: '0xdef567890abcdef1234567890abcdef123456789'
            }
        ];

        const mockTransactions = [
            {
                type: 'X-Ray Imaging Payment',
                amount: 320.00,
                date: '2025-01-12',
                hash: '0xabcd1234ef5678901234567890abcdef12345678',
                network: 'DIDLab QBFT'
            },
            {
                type: 'Prescription - Metformin',
                amount: 32.00,
                date: '2024-12-21',
                hash: '0xdef567890abcdef1234567890abcdef123456789',
                network: 'DIDLab QBFT'
            }
        ];

        // Navigation
        function showSection(sectionName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');

            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            document.getElementById(`${sectionName}Section`).classList.add('active');
        }

        // Load bills
        function loadBills() {
            const billsList = document.getElementById('billsList');
            
            billsList.innerHTML = mockBills.map(bill => `
                <div class="bill-card">
                    <div class="bill-header">
                        <div class="bill-info">
                            <h3>${bill.type}</h3>
                            <div class="bill-id">${bill.id}</div>
                        </div>
                        <div class="bill-amount">$${bill.amount.toFixed(2)}</div>
                    </div>
                    <div class="bill-details">
                        <div class="bill-detail">
                            <span class="bill-detail-label">Provider</span>
                            <span class="bill-detail-value">${bill.provider}</span>
                        </div>
                        <div class="bill-detail">
                            <span class="bill-detail-label">Date of Service</span>
                            <span class="bill-detail-value">${new Date(bill.date).toLocaleDateString()}</span>
                        </div>
                        <div class="bill-detail">
                            <span class="bill-detail-label">Description</span>
                            <span class="bill-detail-value">${bill.description}</span>
                        </div>
                    </div>
                    ${bill.status === 'paid' ? `
                        <div class="bill-status status-paid">
                            ✅ Paid on ${new Date(bill.paidDate).toLocaleDateString()}
                        </div>
                        <div style="margin-top: 15px;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Transaction Hash:</div>
                            <div style="font-size: 12px; color: #1f2937; font-family: monospace; margin-bottom: 10px;">
                                ${bill.transactionHash}
                            </div>
                            <a href="https://explorer.didlab.org/tx/${bill.transactionHash}" target="_blank" class="explorer-badge">
                                🔍 View on DIDLab Explorer
                            </a>
                        </div>
                    ` : `
                        <div class="bill-status status-pending">⏳ Pending Payment</div>
                        <button class="pay-btn" onclick="openPaymentModal('bill', '${bill.id}')">
                            Pay $${bill.amount.toFixed(2)} via DIDLab Blockchain
                        </button>
                    `}
                </div>
            `).join('');
        }

        // Load prescriptions
        function loadPrescriptions() {
            const prescriptionsList = document.getElementById('prescriptionsList');
            
            prescriptionsList.innerHTML = mockPrescriptions.map(rx => `
                <div class="bill-card">
                    <div class="bill-header">
                        <div class="bill-info">
                            <h3>${rx.medication}</h3>
                            <div class="bill-id">${rx.id}</div>
                        </div>
                        <div class="bill-amount">$${rx.amount.toFixed(2)}</div>
                    </div>
                    <div class="bill-details">
                        <div class="bill-detail">
                            <span class="bill-detail-label">Prescriber</span>
                            <span class="bill-detail-value">${rx.prescriber}</span>
                        </div>
                        <div class="bill-detail">
                            <span class="bill-detail-label">Pharmacy</span>
                            <span class="bill-detail-value">${rx.pharmacy}</span>
                        </div>
                        <div class="bill-detail">
                            <span class="bill-detail-label">Quantity</span>
                            <span class="bill-detail-value">${rx.quantity} tablets</span>
                        </div>
                        <div class="bill-detail">
                            <span class="bill-detail-label">Refills</span>
                            <span class="bill-detail-value">${rx.refills} remaining</span>
                        </div>
                    </div>
                    ${rx.status === 'paid' ? `
                        <div class="bill-status status-paid">
                            ✅ Paid on ${new Date(rx.paidDate).toLocaleDateString()}
                        </div>
                        <div style="margin-top: 15px;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Transaction Hash:</div>
                            <div style="font-size: 12px; color: #1f2937; font-family: monospace; margin-bottom: 10px;">
                                ${rx.transactionHash}
                            </div>
                            <a href="https://explorer.didlab.org/tx/${rx.transactionHash}" target="_blank" class="explorer-badge">
                                🔍 View on DIDLab Explorer
                            </a>
                        </div>
                    ` : `
                        <div class="bill-status status-pending">⏳ Pending Payment</div>
                        <button class="pay-btn" onclick="openPaymentModal('prescription', '${rx.id}')">
                            Pay $${rx.amount.toFixed(2)} via DIDLab Blockchain
                        </button>
                    `}
                </div>
            `).join('');
        }

        // Load transactions
        function loadTransactions() {
            const transactionHistory = document.getElementById('transactionHistory');
            const recentActivity = document.getElementById('recentActivity');
            const fullTransactionList = document.getElementById('fullTransactionList');
            
            if (mockTransactions.length === 0) {
                const emptyHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">📊</div>
                        <p>No transactions yet</p>
                    </div>
                `;
                transactionHistory.innerHTML = emptyHTML;
                recentActivity.innerHTML = emptyHTML;
                fullTransactionList.innerHTML = emptyHTML;
                return;
            }

            const transactionHTML = mockTransactions.map(tx => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-type">${tx.type}</div>
                        <div class="transaction-meta">${new Date(tx.date).toLocaleDateString()} • ${tx.network}</div>
                    </div>
                    <div class="transaction-amount">-$${tx.amount.toFixed(2)}</div>
                </div>
            `).join('');

            const detailedTransactionHTML = mockTransactions.map(tx => `
                <div class="tx-detail-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #1f2937; margin-bottom: 5px; font-size: 18px;">${tx.type}</h3>
                            <div style="color: #6b7280; font-size: 13px;">${new Date(tx.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                        <div style="font-size: 28px; font-weight: 700; color: #10b981;">-$${tx.amount.toFixed(2)}</div>
                    </div>
                    <div class="tx-detail-row">
                        <span class="tx-detail-label">Transaction Hash</span>
                        <span class="tx-detail-value">${tx.hash}</span>
                    </div>
                    <div class="tx-detail-row">
                        <span class="tx-detail-label">Network</span>
                        <span class="tx-detail-value">${tx.network}</span>
                    </div>
                    <div class="tx-detail-row">
                        <span class="tx-detail-label">Status</span>
                        <span class="tx-detail-value" style="color: #10b981;">✅ Confirmed</span>
                    </div>
                    <div class="tx-detail-row">
                        <span class="tx-detail-label">Gas Used</span>
                        <span class="tx-detail-value">${Math.floor(Math.random() * 50000 + 21000)} TT</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <a href="https://explorer.didlab.org/tx/${tx.hash}" target="_blank" class="explorer-badge">
                            🔍 View Full Details on DIDLab Explorer
                        </a>
                    </div>
                </div>
            `).join('');

            transactionHistory.innerHTML = transactionHTML;
            recentActivity.innerHTML = transactionHTML;
            fullTransactionList.innerHTML = detailedTransactionHTML;
        }

        // Open payment modal
        function openPaymentModal(type, id) {
            currentPaymentItem = { type, id };
            
            let item;
            if (type === 'bill') {
                item = mockBills.find(b => b.id === id);
            } else {
                item = mockPrescriptions.find(p => p.id === id);
            }

            if (!item) return;

            const paymentDetails = document.getElementById('paymentDetails');
            paymentDetails.innerHTML = `
                <div class="card" style="margin-bottom: 20px;">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Type</div>
                            <div class="info-value">${type === 'bill' ? 'Medical Bill' : 'Prescription'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ID</div>
                            <div class="info-value">${item.id}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Description</div>
                            <div class="info-value">${type === 'bill' ? item.type : item.medication}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Amount</div>
                            <div class="info-value" style="color: #667eea; font-size: 24px;">$${item.amount.toFixed(2)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Network</div>
                            <div class="info-value">DIDLab QBFT (Besu)</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Gas Token</div>
                            <div class="info-value">Trust Token (TT)</div>
                        </div>
                    </div>
                </div>
                <div class="warning-box">
                    <strong>⚠️ Transaction Notice:</strong> This payment will be processed on the DIDLab QBFT blockchain network using Hyperledger Besu. Gas fees in Trust Tokens (TT) may apply. Once confirmed, this transaction is immutable and cannot be reversed.
                </div>
            `;

            document.getElementById('paymentModal').classList.add('show');
        }

        // Close modal
        function closeModal() {
            document.getElementById('paymentModal').classList.remove('show');
            currentPaymentItem = null;
        }

        // Process payment
        async function processPayment() {
            if (!currentPaymentItem) return;

            // Check blockchain connection
            if (!isBlockchainConnected || !contract || !signer) {
                alert('⚠️ Wallet not connected!\n\nPlease click "Connect Wallet" button first to make blockchain payments.');
                closeModal();
                return;
            }

            const confirmBtn = document.getElementById('confirmPayBtn');
            const originalText = confirmBtn.textContent;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="loading-spinner"></span>Processing on DIDLab Network...';

            try {
                // Get item details
                const item = currentPaymentItem.type === 'bill' 
                    ? mockBills.find(b => b.id === currentPaymentItem.id)
                    : mockPrescriptions.find(p => p.id === currentPaymentItem.id);

                if (!item) throw new Error('Item not found');

                // Get current patient data
                const patientData = JSON.parse(sessionStorage.getItem('currentPatient'));
                const memberID = patientData.memberID;

                // Generate payment ID
                const paymentId = `PAY${Date.now()}${Math.random().toString(36).substr(2, 6).toUpperCase()}`;

                // Convert amount to wei (assuming 1 token = 1 USD for simplicity)
                const amountInWei = ethers.utils.parseEther(item.amount.toString());

                console.log('\n========================================');
                console.log('SUBMITTING BLOCKCHAIN PAYMENT');
                console.log('========================================');
                console.log('Payment ID:', paymentId);
                console.log('Item ID:', item.id);
                console.log('Item Type:', currentPaymentItem.type);
                console.log('Amount (USD):', item.amount);
                console.log('Amount (Wei):', amountInWei.toString());
                console.log('Member ID:', memberID);
                console.log('From Wallet:', userAddress);
                console.log('To Contract:', PAYMENT_CONTRACT_ADDRESS);
                console.log('========================================\n');

                // Call smart contract - REAL BLOCKCHAIN TRANSACTION
                const tx = await contract.processPayment(
                    paymentId,
                    item.id,
                    currentPaymentItem.type,
                    memberID,
                    { value: amountInWei }
                );

                console.log('✅ Transaction submitted!');
                console.log('Transaction Hash:', tx.hash);
                
                confirmBtn.innerHTML = '<span class="loading-spinner"></span>Waiting for confirmation...';

                // Wait for transaction to be mined
                const receipt = await tx.wait();
                
                console.log('\n========================================');
                console.log('✅ TRANSACTION CONFIRMED!');
                console.log('========================================');
                console.log('Transaction Hash:', receipt.transactionHash);
                console.log('Block Number:', receipt.blockNumber);
                console.log('Gas Used:', receipt.gasUsed.toString());
                console.log('Status:', receipt.status === 1 ? 'Success' : 'Failed');
                console.log('========================================\n');

                // Update item status
                item.status = 'paid';
                item.paidDate = new Date().toISOString().split('T')[0];
                item.transactionHash = receipt.transactionHash;
                item.blockNumber = receipt.blockNumber;

                // Add to transaction history
                mockTransactions.unshift({
                    type: currentPaymentItem.type === 'bill' ? item.type + ' Payment' : `Prescription - ${item.medication}`,
                    amount: item.amount,
                    date: new Date().toISOString().split('T')[0],
                    hash: receipt.transactionHash,
                    network: 'DIDLab QBFT',
                    blockNumber: receipt.blockNumber
                });

                // Refresh UI
                loadBills();
                loadPrescriptions();
                loadTransactions();
                updateStats();
                closeModal();
                
                // Show success message
                const explorerUrl = `https://explorer.didlab.org/tx/${receipt.transactionHash}`;
                alert(`✅ Payment Successful!\n\n` +
                      `Network: DIDLab QBFT (Hyperledger Besu)\n` +
                      `Transaction Hash: ${receipt.transactionHash}\n` +
                      `Block Number: ${receipt.blockNumber}\n` +
                      `Amount: $${item.amount.toFixed(2)}\n` +
                      `Gas Used: ${receipt.gasUsed.toString()} TT\n\n` +
                      `View on Explorer:\n${explorerUrl}`);

            } catch (error) {
                console.error('\n❌ PAYMENT FAILED');
                console.error('========================================');
                console.error('Error:', error);
                console.error('========================================\n');
                
                let errorMessage = 'Payment failed. ';
                
                if (error.code === 4001) {
                    errorMessage += 'Transaction rejected by user.';
                } else if (error.code === 'INSUFFICIENT_FUNDS') {
                    errorMessage += 'Insufficient funds in wallet. Please add TT tokens to your wallet.';
                } else if (error.message && error.message.includes('user rejected')) {
                    errorMessage += 'Transaction rejected by user.';
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Unknown error occurred. Check console for details.';
                }
                
                alert('❌ ' + errorMessage);
                
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
            }
        }

        // Update stats
        function updateStats() {
            const outstanding = mockBills.filter(b => b.status === 'pending').reduce((sum, b) => sum + b.amount, 0) +
                               mockPrescriptions.filter(p => p.status === 'pending').reduce((sum, p) => sum + p.amount, 0);
            
            const paid = mockBills.filter(b => b.status === 'paid').reduce((sum, b) => sum + b.amount, 0) +
                        mockPrescriptions.filter(p => p.status === 'paid').reduce((sum, p) => sum + p.amount, 0);

            document.getElementById('outstandingBalance').textContent = `$${outstanding.toFixed(2)}`;
            document.getElementById('totalPaid').textContent = `$${paid.toFixed(2)}`;
            document.getElementById('walletBalance').textContent = `$${paid.toFixed(2)}`;
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                sessionStorage.removeItem('currentPatient');
                window.location.href = 'patient-login.html';
            }
        }

        // Load patient data from session
        function loadPatientData() {
            const storedPatient = sessionStorage.getItem('currentPatient');
            
            console.log('Checking for patient data...', storedPatient);
            
            if (!storedPatient) {
                // No patient data, redirect to login
                console.log('No patient data found, redirecting to login');
                alert('Please log in first');
                window.location.href = 'patient-login.html';
                return false;
            }

            try {
                const patientData = JSON.parse(storedPatient);
                console.log('Patient data loaded:', patientData);
                
                // Update header with patient info
                document.getElementById('userName').textContent = patientData.patientName || 'Patient';
                document.getElementById('userID').textContent = patientData.memberID || 'N/A';
                
                // Update profile section
                const profileSection = document.getElementById('profileSection');
                profileSection.innerHTML = `
                    <h1 class="page-title">Patient Profile</h1>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <span>👤</span>
                                Personal Information
                            </div>
                        </div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Full Name</div>
                                <div class="info-value">${patientData.patientName || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Member ID</div>
                                <div class="info-value">${patientData.memberID || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Email</div>
                                <div class="info-value">${patientData.email || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Date of Birth</div>
                                <div class="info-value">${patientData.dateOfBirth ? new Date(patientData.dateOfBirth).toLocaleDateString() : 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Registration Date</div>
                                <div class="info-value">${patientData.registeredAt ? new Date(patientData.registeredAt).toLocaleDateString() : 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Account Status</div>
                                <div class="info-value" style="color: #10b981;">${patientData.emailVerified ? '✅ Verified' : '⚠️ Pending'}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Update wallet address if available
                if (patientData.walletAddress) {
                    document.getElementById('walletAddress').textContent = patientData.walletAddress;
                }

                return true;

            } catch (error) {
                console.error('Error loading patient data:', error);
                alert('Error loading patient data. Please log in again.');
                window.location.href = 'patient-login.html';
                return false;
            }
        }

        // Initialize
        window.addEventListener('load', async () => {
            console.log('Dashboard loading...');
            
            // Load patient data first
            const dataLoaded = loadPatientData();
            
            if (dataLoaded !== false) {
                // Try to auto-initialize blockchain (if already connected)
                await initBlockchain();
                
                // Then load dashboard content
                console.log('Loading dashboard content...');
                loadBills();
                loadPrescriptions();
                loadTransactions();
                updateStats();
                console.log('Dashboard loaded successfully');
            }
        });
    </script></body>
</html>